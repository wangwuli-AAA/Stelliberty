name: Flutter ä»£ç æ£€æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  flutter-checks:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: false

      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: cargo install rinf_cli && rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: æ£€æŸ¥ Dart ä»£ç æ ¼å¼
        shell: bash
        run: |
          echo "ğŸ” æ£€æŸ¥ Dart ä»£ç æ ¼å¼ï¼ˆæ’é™¤è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶ï¼‰..."
          
          # æ’é™¤è‡ªåŠ¨ç”Ÿæˆçš„ç›®å½•ï¼šlib/src/bindings, lib/i18n
          find . -name "*.dart" \
            -not -path "./lib/src/bindings/*" \
            -not -path "./lib/i18n/*" \
            -not -path "./build/*" \
            > dart_files.txt
          
          if [ -s dart_files.txt ]; then
            if ! cat dart_files.txt | xargs dart format --output=none --set-exit-if-changed; then
              echo ""
              echo "âŒ Dart ä»£ç æ ¼å¼ä¸è§„èŒƒï¼"
              echo ""
              echo "è¯·åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼ˆæ’é™¤è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶ï¼‰ï¼š"
              echo "  find . -name \"*.dart\" -not -path \"./lib/src/bindings/*\" -not -path \"./lib/i18n/*\" | xargs dart format"
              echo ""
              rm dart_files.txt
              exit 1
            fi
          fi
          
          rm -f dart_files.txt
          echo "âœ… Dart ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

      - name: è¿è¡Œ Flutter é™æ€åˆ†æ
        run: flutter analyze