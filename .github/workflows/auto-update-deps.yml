name: è‡ªåŠ¨æ›´æ–°ä¾èµ–

on:
  schedule:
    - cron: "0 21 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-deps:
    name: è‡ªåŠ¨æ›´æ–°ä¾èµ–
    runs-on: ubuntu-latest

    steps:
      - name: æ‹‰å–ä»“åº“
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: false

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        if: steps.check_deps.outputs.has_changes == 'true'
        run: cargo install rinf_cli && rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        if: steps.check_deps.outputs.has_changes == 'true'
        run: dart run slang

      - name: å®‰è£…é¢„æ„å»ºè„šæœ¬ä¾èµ–
        run: dart pub get
        working-directory: scripts

      - name: è¿è¡Œé¢„æ„å»ºè„šæœ¬
        run: dart run scripts/prebuild.dart

      - name: æ›´æ–° Flutter ä¾èµ–
        run: |
          flutter pub upgrade
          flutter pub outdated || true

      - name: æ›´æ–° Rust ä¾èµ–
        run: cargo update --manifest-path native/hub/Cargo.toml

      - name: æ£€æŸ¥ä¾èµ–æ–‡ä»¶æ˜¯å¦æœ‰å˜æ›´
        id: check_deps
        run: |
          git diff --quiet pubspec.lock native/hub/Cargo.lock && echo "has_changes=false" >> $GITHUB_OUTPUT || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ Flutter ä»£ç å¯è¡Œæ€§
        if: steps.check_deps.outputs.has_changes == 'true'
        run: flutter analyze

      - name: æ£€æŸ¥ Rust ä»£ç å¯è¡Œæ€§
        if: steps.check_deps.outputs.has_changes == 'true'
        run: cargo check --manifest-path native/hub/Cargo.toml

      - name: åˆ›å»º Pull Request
        if: steps.check_deps.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): è‡ªåŠ¨æ›´æ–° Flutter ä¸ Rust ä¾èµ–"
          branch: auto-update-deps
          delete-branch: true
          title: "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä¾èµ–"
          body: |
            ## ğŸ“¦ ä¾èµ–æ›´æ–°æ‘˜è¦
            
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
            
            ### æ›´æ–°å†…å®¹
            - âœ… Flutter ä¾èµ–å·²æ›´æ–°åˆ°æœ€æ–°å…¼å®¹ç‰ˆæœ¬
            - âœ… Rust ä¾èµ–å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
            - âœ… å·²é‡æ–°ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
            - âœ… å·²é‡æ–°ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
            - âœ… å·²é€šè¿‡ `flutter analyze` æ£€æŸ¥
            - âœ… å·²é€šè¿‡ `cargo check` æ£€æŸ¥
            
            ### ğŸ“‹ å˜æ›´æ–‡ä»¶
            - `pubspec.lock` - Flutter ä¾èµ–é”å®šæ–‡ä»¶
            - `native/hub/Cargo.lock` - Rust ä¾èµ–é”å®šæ–‡ä»¶
            - è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç æ–‡ä»¶
            
            ### âš ï¸ å®¡æŸ¥å»ºè®®
            è¯·åœ¨åˆå¹¶å‰æ£€æŸ¥ï¼š
            1. æŸ¥çœ‹ä¾èµ–ç‰ˆæœ¬å˜åŒ–æ˜¯å¦åˆç†
            2. ç¡®è®¤æ²¡æœ‰å¼•å…¥ç ´åæ€§æ›´æ”¹
            3. å¦‚æœ‰å¿…è¦ï¼Œè¿›è¡Œæœ¬åœ°æµ‹è¯•
            
            ---
            
            ğŸ’¡ **æç¤º**: å¦‚æœæ­¤ PR æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥åˆå¹¶ã€‚å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥å…³é—­æ­¤ PRï¼Œä¾èµ–æ›´æ–°å°†åœ¨ä¸‹æ¬¡å®šæ—¶ä»»åŠ¡æ—¶é‡æ–°å°è¯•ã€‚
          labels: |
            dependencies
            automated
          assignees: ${{ github.repository_owner }}

      - name: æ— éœ€æ›´æ–°
        if: steps.check_deps.outputs.has_changes == 'false'
        run: echo "âœ… ä¾èµ–æ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æ›´æ–°ã€‚"
